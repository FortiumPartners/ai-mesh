{{/* Alert Templates for Enhanced Notifications */}}
{{/* Task 5.2: Alert Rules Configuration (Sprint 5) */}}

{{/* ========================================================================= */}}
{{/* EMAIL TEMPLATES */}}
{{/* ========================================================================= */}}

{{/* Critical Alert Email Template */}}
{{ define "critical.email.subject" }}üö® CRITICAL (P1): {{ .GroupLabels.alertname }} - IMMEDIATE ACTION REQUIRED{{ end }}

{{ define "critical.email.body" }}
üö® CRITICAL ALERT - IMMEDIATE RESPONSE REQUIRED üö®

{{ range .Alerts }}
Alert: {{ .Annotations.summary }}
Priority: {{ .Labels.priority }}
Service: {{ .Labels.service }}
Team: {{ .Labels.team }}
Severity: {{ .Labels.severity }}

Description: 
{{ .Annotations.description }}

Business Impact: 
{{ .Annotations.impact }}

Required Action: 
{{ .Annotations.action }}

üìñ Runbook: {{ .Annotations.runbook }}
üìä Dashboard: {{ .Annotations.dashboard }}

Current Metrics:
{{- range .Annotations.SortedPairs }}
{{- if hasPrefix .Name "current_" }}
  - {{ .Name | reReplaceAll "current_" "" | title }}: {{ .Value }}
{{- end }}
{{- end }}

Instance Details:
{{- range .Labels.SortedPairs }}
  - {{ .Name }}: {{ .Value }}
{{- end }}

Timeline:
  - Alert Fired: {{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}
  {{- if .EndsAt }}
  - Resolved: {{ .EndsAt.Format "2006-01-02 15:04:05 MST" }}
  - Duration: {{ .EndsAt.Sub .StartsAt }}
  {{- else }}
  - Status: ACTIVE
  - Duration: {{ since .StartsAt }}
  {{- end }}

Next Steps:
1. Acknowledge this alert immediately
2. Follow the runbook procedures
3. Update #critical-alerts Slack channel with status
4. Escalate to senior engineer if not resolved in 10 minutes

{{ end }}

---
This is an automated alert from SignOz Monitoring System.
For urgent assistance: oncall-engineer@fortium.dev | Phone: +1-555-ONCALL
{{ end }}

{{/* High Priority Alert Email Template */}}
{{ define "high.email.subject" }}‚ö†Ô∏è HIGH (P2): {{ .GroupLabels.alertname }} - Response within 15 minutes{{ end }}

{{ define "high.email.body" }}
‚ö†Ô∏è HIGH PRIORITY ALERT - RESPONSE REQUIRED WITHIN 15 MINUTES ‚ö†Ô∏è

{{ range .Alerts }}
Alert: {{ .Annotations.summary }}
Priority: {{ .Labels.priority }}
Service: {{ .Labels.service }}
Team: {{ .Labels.team }}

Description: {{ .Annotations.description }}
Impact: {{ .Annotations.impact }}
Action Required: {{ .Annotations.action }}

üìñ Runbook: {{ .Annotations.runbook }}
üìä Dashboard: {{ .Annotations.dashboard }}

Alert Details:
  - Fired: {{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}
  {{- if .EndsAt }}
  - Resolved: {{ .EndsAt.Format "2006-01-02 15:04:05 MST" }}
  {{- else }}
  - Status: ACTIVE ({{ since .StartsAt }})
  {{- end }}
  - Instance: {{ .Labels.instance }}
  - Environment: {{ .Labels.environment | default "production" }}

{{ end }}

Please investigate and take appropriate action within 15 minutes.
Update #platform-alerts with your findings and actions taken.
{{ end }}

{{/* Medium Priority Alert Email Template */}}
{{ define "medium.email.subject" }}üìä MEDIUM (P3): {{ .GroupLabels.alertname }} - Response within 1 hour{{ end }}

{{ define "medium.email.body" }}
üìä MEDIUM PRIORITY ALERT - RESPONSE REQUIRED WITHIN 1 HOUR

{{ range .Alerts }}
Alert: {{ .Annotations.summary }}
Service: {{ .Labels.service }}
Priority: {{ .Labels.priority }}

Description: {{ .Annotations.description }}
Action Required: {{ .Annotations.action }}

Resources:
  - Runbook: {{ .Annotations.runbook }}
  - Dashboard: {{ .Annotations.dashboard }}

Alert fired at: {{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}
{{ if .EndsAt }}Alert resolved at: {{ .EndsAt.Format "2006-01-02 15:04:05 MST" }}{{ end }}

{{ end }}

Please investigate within 1 hour and update the team on #monitoring channel.
{{ end }}

{{/* Low Priority Alert Email Template */}}
{{ define "low.email.subject" }}üìà LOW (P4): {{ .GroupLabels.alertname }} - Response within 4 hours{{ end }}

{{ define "low.email.body" }}
üìà LOW PRIORITY ALERT - RESPONSE REQUIRED WITHIN 4 HOURS

{{ range .Alerts }}
Alert: {{ .Annotations.summary }}
Service: {{ .Labels.service }}

Description: {{ .Annotations.description }}

This is a low-priority monitoring alert that requires attention within 4 hours.
Please review when convenient during business hours.

Alert Details:
  - Fired: {{ .StartsAt.Format "2006-01-02 15:04:05 MST" }}
  - Runbook: {{ .Annotations.runbook }}
  - Dashboard: {{ .Annotations.dashboard }}

{{ end }}
{{ end }}

{{/* ========================================================================= */}}
{{/* SLACK TEMPLATES */}}
{{/* ========================================================================= */}}

{{/* Critical Alert Slack Template */}}
{{ define "critical.slack.title" }}üö® CRITICAL (P1): {{ .GroupLabels.alertname }}{{ end }}

{{ define "critical.slack.text" }}
{{ range .Alerts }}
**{{ .Annotations.summary }}**

üî• **IMMEDIATE ACTION REQUIRED** üî•

‚Ä¢ **Priority:** {{ .Labels.priority }}
‚Ä¢ **Service:** {{ .Labels.service }}
‚Ä¢ **Team:** <@{{ .Labels.team }}-team>
‚Ä¢ **Impact:** {{ .Annotations.impact }}

**Required Action:** {{ .Annotations.action }}

**Timeline:**
‚Ä¢ Fired: {{ .StartsAt.Format "15:04:05 MST" }}
{{ if .EndsAt }}‚Ä¢ Resolved: {{ .EndsAt.Format "15:04:05 MST" }}{{ else }}‚Ä¢ Status: üî¥ ACTIVE ({{ since .StartsAt }}){{ end }}

**Resources:**
<{{ .Annotations.runbook }}|üìñ Runbook> | <{{ .Annotations.dashboard }}|üìä Dashboard>

**Current Values:**
{{- range .Annotations.SortedPairs }}
{{- if hasPrefix .Name "current_" }}
‚Ä¢ {{ .Name | reReplaceAll "current_" "" | title }}: `{{ .Value }}`
{{- end }}
{{- end }}

**Instance:** {{ .Labels.instance }}

---
‚ö° **Next Steps:**
1. React with ‚úÖ when you start investigating
2. Follow the runbook procedures
3. Update this thread with progress every 5 minutes
4. Escalate if not resolved in 10 minutes

{{ end }}
{{ end }}

{{/* High Priority Alert Slack Template */}}
{{ define "high.slack.title" }}‚ö†Ô∏è HIGH (P2): {{ .GroupLabels.alertname }}{{ end }}

{{ define "high.slack.text" }}
{{ range .Alerts }}
**{{ .Annotations.summary }}**

‚Ä¢ **Priority:** {{ .Labels.priority }}
‚Ä¢ **Service:** {{ .Labels.service }}
‚Ä¢ **Team:** {{ .Labels.team }}
‚Ä¢ **Impact:** {{ .Annotations.impact }}

**Required Action:** {{ .Annotations.action }}

**Timeline:**
‚Ä¢ Fired: {{ .StartsAt.Format "15:04:05 MST" }}
{{ if .EndsAt }}‚Ä¢ Resolved: {{ .EndsAt.Format "15:04:05 MST" }}{{ else }}‚Ä¢ Status: üü° ACTIVE ({{ since .StartsAt }}){{ end }}

<{{ .Annotations.runbook }}|üìñ Runbook> | <{{ .Annotations.dashboard }}|üìä Dashboard>

**Response required within 15 minutes** ‚è∞

{{ end }}
{{ end }}

{{/* Medium Priority Alert Slack Template */}}
{{ define "medium.slack.title" }}üìä MEDIUM (P3): {{ .GroupLabels.alertname }}{{ end }}

{{ define "medium.slack.text" }}
{{ range .Alerts }}
**{{ .Annotations.summary }}**

‚Ä¢ **Service:** {{ .Labels.service }}
‚Ä¢ **Priority:** {{ .Labels.priority }}

{{ .Annotations.description }}

**Action:** {{ .Annotations.action }}

<{{ .Annotations.runbook }}|üìñ Runbook> | <{{ .Annotations.dashboard }}|üìä Dashboard>

{{ if .EndsAt }}üü¢ Resolved after {{ .EndsAt.Sub .StartsAt }}{{ else }}üü° Active for {{ since .StartsAt }}{{ end }}

*Response required within 1 hour*

{{ end }}
{{ end }}

{{/* Low Priority Alert Slack Template */}}
{{ define "low.slack.title" }}üìà LOW (P4): {{ .GroupLabels.alertname }}{{ end }}

{{ define "low.slack.text" }}
{{ range .Alerts }}
**{{ .Annotations.summary }}**

‚Ä¢ **Service:** {{ .Labels.service }}

{{ .Annotations.description }}

<{{ .Annotations.runbook }}|üìñ Runbook>

{{ if .EndsAt }}‚úÖ Resolved{{ else }}‚ÑπÔ∏è Active for {{ since .StartsAt }}{{ end }}

*Response required within 4 hours (business hours only)*

{{ end }}
{{ end }}

{{/* ========================================================================= */}}
{{/* WEBHOOK TEMPLATES */}}
{{/* ========================================================================= */}}

{{/* Critical Alert Webhook Payload */}}
{{ define "critical.webhook.body" }}
{
  "alertname": "{{ .GroupLabels.alertname }}",
  "status": "{{ .Status }}",
  "priority": "P1",
  "severity": "critical",
  "alerts": [
    {{ range $i, $alert := .Alerts }}
    {{ if $i }},{{ end }}
    {
      "summary": "{{ $alert.Annotations.summary }}",
      "description": "{{ $alert.Annotations.description }}",
      "impact": "{{ $alert.Annotations.impact }}",
      "action": "{{ $alert.Annotations.action }}",
      "runbook": "{{ $alert.Annotations.runbook }}",
      "dashboard": "{{ $alert.Annotations.dashboard }}",
      "service": "{{ $alert.Labels.service }}",
      "team": "{{ $alert.Labels.team }}",
      "instance": "{{ $alert.Labels.instance }}",
      "startsAt": "{{ $alert.StartsAt }}",
      "endsAt": "{{ $alert.EndsAt }}",
      "generatorURL": "{{ $alert.GeneratorURL }}",
      "labels": {{ $alert.Labels | toJSON }},
      "annotations": {{ $alert.Annotations | toJSON }}
    }
    {{ end }}
  ],
  "groupLabels": {{ .GroupLabels | toJSON }},
  "commonLabels": {{ .CommonLabels | toJSON }},
  "commonAnnotations": {{ .CommonAnnotations | toJSON }},
  "externalURL": "{{ .ExternalURL }}",
  "version": "4",
  "groupKey": "{{ .GroupKey }}",
  "truncatedAlerts": {{ .TruncatedAlerts }}
}
{{ end }}

{{/* ========================================================================= */}}
{{/* PAGERDUTY TEMPLATES */}}
{{/* ========================================================================= */}}

{{/* Critical Alert PagerDuty Template */}}
{{ define "pagerduty.critical.description" }}
{{ range .Alerts }}{{ .Annotations.summary }} on {{ .Labels.instance }} - {{ .Annotations.impact }}{{ end }}
{{ end }}

{{/* ========================================================================= */}}
{{/* UTILITY TEMPLATES */}}
{{/* ========================================================================= */}}

{{/* Common Alert Footer */}}
{{ define "alert.footer" }}
---
ü§ñ Automated alert from SignOz Monitoring System
üìÖ Generated: {{ now.Format "2006-01-02 15:04:05 MST" }}
üîó Alert Manager: {{ .ExternalURL }}
{{ end }}

{{/* Alert Status Icon */}}
{{ define "alert.status.icon" }}
{{ if eq .Status "firing" }}üî¥{{ else if eq .Status "resolved" }}üü¢{{ else }}üü°{{ end }}
{{ end }}

{{/* Priority Icon */}}
{{ define "alert.priority.icon" }}
{{ if eq .Labels.priority "P1" }}üö®{{ else if eq .Labels.priority "P2" }}‚ö†Ô∏è{{ else if eq .Labels.priority "P3" }}üìä{{ else }}üìà{{ end }}
{{ end }}

{{/* Time Since Helper */}}
{{ define "time.since" }}
{{ $duration := since .StartsAt }}
{{ if lt $duration.Minutes 60 }}{{ printf "%.0fm" $duration.Minutes }}{{ else if lt $duration.Hours 24 }}{{ printf "%.1fh" $duration.Hours }}{{ else }}{{ printf "%.1fd" (div $duration.Hours 24) }}{{ end }}
{{ end }}

{{/* Threshold Status Helper */}}
{{ define "threshold.status" }}
{{ range .Annotations.SortedPairs }}
{{ if eq .Name "current_value" }}Current: {{ .Value }}{{ end }}
{{ if eq .Name "threshold" }}Threshold: {{ .Value }}{{ end }}
{{ end }}
{{ end }}

{{/* Service Health Status */}}
{{ define "service.health" }}
{{ if eq .Labels.service "monitoring-web-service" }}üñ•Ô∏è{{ else if eq .Labels.service "postgresql" }}üóÑÔ∏è{{ else if eq .Labels.service "websocket" }}‚ö°{{ else }}üîß{{ end }} {{ .Labels.service }}
{{ end }}

{{/* Team Mention Helper */}}
{{ define "team.mention" }}
{{ if eq .Labels.team "platform" }}@platform-team{{ else if eq .Labels.team "security" }}@security-team{{ else if eq .Labels.team "database" }}@database-team{{ else }}@{{ .Labels.team }}-team{{ end }}
{{ end }}

{{/* Environment Badge */}}
{{ define "environment.badge" }}
{{ $env := .Labels.environment | default "production" }}
{{ if eq $env "production" }}üî¥ PROD{{ else if eq $env "staging" }}üü° STAGING{{ else if eq $env "development" }}üü¢ DEV{{ else }}‚ö™ {{ upper $env }}{{ end }}
{{ end }}